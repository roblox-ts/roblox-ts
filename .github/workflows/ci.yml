name: CI

on:
  pull_request:
  push:
    branches:
      - master

env:
  ROBLOSECURITY: ${{ secrets.ROBLOSECURITY || '_|WARNING:-DO-NOT-SHARE-THIS.--Sharing-this-will-allow-someone-to-log-in-as-you-and-to-steal-your-ROBUX-and-items.|_702850875B64E324D3791C4A9CBDA3D3A14A9AA935CDB7B6C87D238D79BCE07B6933A75B16959B1B28B9F237C6AAB54626BC78BC4F6BE93893DCFECFB1427E1A1042F1A5E3C6B8C25D4645D6BE0310A0208A3ACDD1385FDE49B0D01DB260B63D3AFDFB11C1D164C7DBD34EFCD2ACD32278540D192EC5717A85E2EBA753783A524205E64C031F143A5ABF72C4BF9939CAAC8908ACF4A18E631D06A3919989C789440693E35FAA91912585377217F481DF98A55068610DCCD3BEB2C1CBADBC8526D69316F8DE399E982E7F1DBB7D504FEBEEE4B87070699BDD2B118FCDC71254E841BD1ED2A4F0AC733A8CF0873ADF7FBC38452B7FA51C265DFD5CDE0D57E008BB721EABBC1D7C01700AADE042516505742320D008D80938C6C7328FB089FF011C9A8DB00AADECBC7B1476791571BC74A99C2F031680050F9E89C23E011510C3EAE3C92947A1F5FBE3D83D8C01263F8E0A5ECE985813390EECB27BD6EAFA675CD37D7B719C0E9713920DD5ED39775FE8288A12B4C38F41C884E7C66BF69A811E1C728EBC2034D0C6712DEDEE9A40090C839B3EAA1C' }}

jobs:
  lint:
    name: ESLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2.3.4

      - name: Install NPM dependencies
        uses: bahmutov/npm-install@v1.7.4

      - name: Run ESLint
        run: npm run eslint
  unit-tests:
    name: Unit Tests
    runs-on: windows-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2.3.4

      - name: Download WireGuard
        run: Invoke-WebRequest -Uri https://github.com/DrEm-s/wireguard-windows-portable/releases/download/v1.0/wireguard.exe -OutFile ./wireguard.exe;

      - name: Run WireGuard
        run: "& ./wireguard.exe /installtunnelservice .\\wireguard.conf"

      - name: Validate Cookie
        run: |
          $session = New-Object Microsoft.PowerShell.Commands.WebRequestSession
          $cookie = New-Object System.Net.Cookie
          $cookie.Name = ".ROBLOSECURITY"
          $cookie.Value = "${{ env.ROBLOSECURITY }}"
          $cookie.Domain = ".roblox.com"
          $session.Cookies.Add($cookie);
          Invoke-WebRequest "https://avatar.roblox.com/v1/avatar" -WebSession $session -UseBasicParsing

      - name: Install Roblox Studio
        uses: OrbitalOwen/roblox-win-installer-action@1.1
        with:
          cookie: ${{ env.ROBLOSECURITY }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Foreman
        uses: rojo-rbx/setup-foreman@v1.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install NPM dependencies
        uses: bahmutov/npm-install@v1.7.4

      - name: Compile and run tests
        run: npm test

      - name: Screenshot
        if: failure()
        uses: OrbitalOwen/desktop-screenshot-action@0.1
        with:
          file-name: 'desktop.jpg'

      - name: Report Coverage
        continue-on-error: true
        uses: coverallsapp/github-action@v1.1.2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
