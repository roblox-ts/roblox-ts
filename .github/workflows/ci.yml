name: CI

on:
  pull_request:
  push:
    branches:
      - master

jobs:
  lint:
    name: ESLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2.3.4

      - name: Install NPM dependencies
        uses: bahmutov/npm-install@v1.7.4

      - name: Run ESLint
        run: npm run eslint
  unit-tests:
    name: Unit Tests
    runs-on: windows-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2.3.4

      - name: Download WireGuard
        run: Invoke-WebRequest -Uri https://github.com/DrEm-s/wireguard-windows-portable/releases/download/v1.0/wireguard.exe -OutFile ./wireguard.exe;

      - name: Run WireGuard
        run: "& ./wireguard.exe /installtunnelservice .\\wireguard.conf"

      - name: Install Roblox Studio
        uses: OrbitalOwen/roblox-win-installer-action@1.1
        with:
          cookie: ${{ secrets.ROBLOSECURITY || '_|WARNING:-DO-NOT-SHARE-THIS.--Sharing-this-will-allow-someone-to-log-in-as-you-and-to-steal-your-ROBUX-and-items.|_99C33268C48E83B5B1B9AFCA27C2CDDC1515F25528F2B7244FE0DB7481ADB0ECBCD1565F305A1C5C63B8F94A8544980884D2BBE7F9CE3ED5F501C0BB09B4D410A31F6998372BF631E6E15000AD994B3CC4E3104FD9DBA7503E6B640983CFA20C43E442684EFAFD3F3F352736D5DAF9C857F2D86C6BA1399F96C6448B87AAD9EFD56291F75B424D0B4844A70CEBE129EE3304219BA821E474D16EA9681E8DF2C56541291FEB804E2698445BE29F429769BFC6155173039401D5725EE9D5C45AD306255B2EFDE77F9F854E4701BCB543550BB18FA1A271738F674B63D38174DDD27017A9D0FA05D7055B61393D4DBEF0488A5FA7077388F6FFA7465E5F65CCDE52C62EB356FD18E2BEBF8A15207501AFD6538D60F54F163B3A3C05FC152789BF14D8F7E2B4AFF4C63612B41AF207E4DDC24BABD4E8249E7F35280CA3625D2F74E05F1C0056C753406391940FD3BD7578D169F42F072B9AB69F78906FC8E9A0CE6B886C6ED20442744FAD376B5D76B2E0541E20D15848ACAAFAFA4C2DC1A0AF05085BE94AE6C998E7CA1D0CEF130D7EDFB5A7867045' }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Foreman
        uses: rojo-rbx/setup-foreman@v1.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install NPM dependencies
        uses: bahmutov/npm-install@v1.7.4

      - name: Compile and run tests
        run: npm test

      - name: Report Coverage
        continue-on-error: true
        uses: coverallsapp/github-action@v1.1.2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
